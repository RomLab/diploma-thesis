\chapter{Návrh konceptu řídícího systému}

\section{Popis celkového konceptu}

Otopná soustava domu je zobrazena na obrázku \ref{fig:otopna-soustava-rez-domu}. Skládá v současné době pouze z jednoho zdroje tepla a to krbů v přízemí a v patře s teplovodními výměníky. Krby s teplovodním výměníkem slouží k ohřevu otopné vody proudící skrz vložku krbu, které dobíjí zásobník otopné vody, dále pak vzniká teplo ze samotného ohně sálající do místnosti. Na každém patře je rozdělovač podlahové topení s 12 topnými okruhy, kde každý okruh se dá ovládat zvlášť (průtok otopné vody). Dále je zde čerpadlo a manuální trojcestný směšovací ventil pro nastavení optimální teploty do podlahového topení. Druhým zdrojem tepla je plynový kondenzační kotel, který není v současnosti pořízen, nicméně se s ním počítá do budoucna. Bude sloužit k ohřívání otopné vody, pokud nebudou využiti krby s teplovodním výměníkem, zejména v letním období pro ohřev teplé užitkové vody (dále jen TUV). Oba zdroje tepla ohřívání otopnou vodu do centrálního zásobníku (objem je 1 500 l). Kde je přibližně v jedné horní třetině výšky zásobníku umístěna nádoba TUV (objem je 120~l). Navržený systém řídí ovládání čerpadel u rozdělovačů podlahové topení, čerpadel pro krby s výměníkem a pohonů pro jednotlivé okruhy podlahové topení. K ovládání čerpadel, topných okruhů dochází při požadavku topení nebo pokud dojde k zatopení v krbech. Řízení podlahové topení respektive pohonů dochází pouze v patře, kde je více obytných místností, dochází ke stoupání teploty z přízemí a proto je výhodnější toto patro regulovat. 


\begin{figure}[H]
    \centering
    \def\svgwidth{\columnwidth}
    \input{images/svg/otopna-soustava-rez-domu.pdf_tex}
    \caption{Otopná soustava v domě.}
    \label{fig:otopna-soustava-rez-domu}
\end{figure}

\subsection{Hardwarová část}

Centrální jednotka je jednodeskový počítač s periferiemi jako ethernetový port, USB, univerzálními vstupy/výstupy, případně s alternativní funkcí pinů jako sběrnice I$^2$C nebo dalšími typy periferií. Dále by měla disponovat dostatečnou velikostí RAM pamětí a relativně výkonným procesorem pro snadné zpracování vstupní/výstupních dat či povelů.

Bezdrátové nástěnné snímače prostorové teploty jsou napájeny z lokálních síťových adaptérů, každý modul má své napájení. Nástěnný snímač prostorové teploty se skládá z displeje pro zobrazení aktuální a požadované teploty a dalších nastavení. Dále ze tří tlačítek pro vstup do menu a tlačítek pro zvýšení/snížení požadované teploty a teplotního senzoru. Komunikace s centrální jednotkou je zajištěny pomocí WiFi modulu skrz WiFi router.

Kabelové nástěnné snímače prostorové teploty jsou napájeny pomocí switche s POE. Nástěnný snímač prostorové teploty se skládá z displeje pro zobrazená aktuální a požadované teploty a dalších nastavení. Dále ze tří tlačítek pro vstup do menu a tlačítek pro zvýšení/snížení požadované teploty a teplotního senzoru. Komunikace s centrální jednotkou je zajištěna skrz zmíněného switche.

Indikátor stavů je propojen přímo s centrální jednotkou, skládá z části indikující stavy pomocí LED pro jednotlivé teploty měřené v zásobníku otopné vody rozmístěné v jednotlivých částech nádrže. Dále je zde sběrnice pro komunikaci LCD displejem a centrální jednotkou pro zobrazení teplot ze zásobníku, respektive dvou teplot ze spodní části. LED diody a LCD displej jsou umístěny u krbů v každém patře.

Spínací jednotka se skládá z relé modulů pro ovládání jednotlivých čerpadel pro oběh otopné vody do podlahové topení v jednotlivých patrech. Dále jsou zde ovládány čerpadla pro cirkulaci vody z krbových výměníků. V neposlední řadě je zde případné ovládání plynové kondenzačního kotle.

Zónový regulátor je umístěn v daném patře v rozdělovači pro jednotlivé topné okruhy. Komunikace mezi zónovým regulátorem a centrální jednotkou je pomocí sběrnice. Zónový regulátor ovládá jednotlivé pohony pro místností pomocí PWM signálu. Pohony jsou přímo připojené na zónový regulátor.

Síťové prvky se skládají z centrálního switche, switche s POE a domácího WiFi routeru. Centrální switch sdružuje veškerou komunikace jak z kabelových nástěnných snímačů prostorové teploty, tak i bezdrátových. Bezdrátové nástěnné snímače prostorové teploty jsou připojeny pomocí WiFi routeru a~ten následně do centrální switche, který přepojuje komunikaci do centrální jednotky. Kabelové nástěnné snímače prostorové teploty jsou připojeny přes switch s POE, který zařízení napájí a přeposílá komunikaci do centrálního switche, který přepojuje komunikaci do centrální jednotky.

Teplotní senzory v zásobníku otopné vody jsou rozmístěné ve třech částech zásobníku. Dále jsou teplotní sensory na kouřovodech u jednotlivých krbů pro detekci topení. Všechny senzory jsou napojeny na jednu sběrnici.

Výše popsaný hardwarový koncept je nakreslen na obrázku \ref{fig:navrh-hardwarove-casti}.

\begin{figure}[H]
    \centering
    \def\svgwidth{\columnwidth}
    \input{images/svg/navrh-hardwarove-casti.pdf_tex}
    \caption{ Návrh hardwarové části systému.}
    \label{fig:navrh-hardwarove-casti}
\end{figure}

\subsubsection{Teplotní čidla}
Jak bylo zmíněno výše, teplotní čidla jsou potřebná na snímání teplot na kouřovodech krbů pro následné sepnutí oběhového čerpadla. Teplota na kouřovodech se může dosáhnout až 300 °C (optimální teplota se však pohybuje přibližně mezi 120 °C až 240 °C, kdy je nejvyšší účinnost kamen a hoření paliva), proto je nutné zvolit takové čidlo, které je na tyto teploty vhodné. Mezi takové teplotní čidlo patří odporové teplotní čidlo (teplotní rozsahy od -240~°C až 600 °C) nebo termočlánek (teplotní rozsahy od -260 °C až 2~300~°C). Pro zjištění teploty není nutná velmi velká přesnost, citlivost, jistým požadavkem je robustnost čidla (nejen ochrana čidla, ale i přívodních kabelů), vzhledem k umístění u krbu, kde je dosahováno vyšších teplot.

Princip termočlánku spočívá v Seebeckově efektu, jsou-li spojeny dva vodiče z různých kovů, tak v místě spojení je generováno napětí. Velikost napětí je závislá na vnější teplotě a materiálu článku. Linearita výstupního napětí článku je závislá na typu termočlánku a rozsahu teplot.

Další teplotní čidla jsou nutná pro nástěnné teplotní snímače pro každou místnost, zásobník otopné vody a venkovní čidlo. Teplotní rozsah těchto čidel nemusí být tak vysoký jako u měření teplot na kouřovodech. Teplotní rozsah stačí v řádů desítek stupňů jak pro kladné, tak i záporné hodnoty teploty. Vzhledem ke vzdálenostem teplotních čidel a centrální jednotky bude lepší zvolit digitální teplotní čidla, které výslednou změřenou teplotu zpracuje pošle po sběrnici v digitální podobě. Není pak nutná další elektronika pro zpracování hodnot teploty jako například u termočlánku či teplotně odporového čidla.

\subsection{Softwarová/komunikační část}

Komunikace mezi centrální řídicí jednotkou a bezdrátovými i kabelovými nástěnnými snímači prostorové teploty je zajištěny pomocí protokolu MQTT. Centrální jednotka dostává informace z jednotlivých nástěnných snímačů prostorové teploty, zároveň je možné některá parametry nastavovat přímo přes centrální jednotku, která následně dané nastavení pošle do daných zařízení.

Indikátor stavů komunikuje s centrální jednotkou pomocí sběrnice I$^2$C pro zobrazení hodnot na LCD displeji. Zároveň je zde přímé připojení na vstupní/výstupní piny centrální jednotky pro ovládání indikačních LED diod.

Spínací jednotka je přímo připojena do centrální jednotky pro spínání daných čerpadel pro podlahové topení, čerpadel pro krbové výměníky a~kondenzačního plynového kotle.

Zónový regulátor komunikuje s centrální jednotkou pomocí I$^2$C sběrnice, následné ovládání pohonů pro topné okruhy je přímo zónovým regulátorem.

Teplotní senzory umístěné v zásobníku otopné vody a na kouřovodech krbů komunikují s centrální jednotkou pomocí 1-Wire sběrnice.

\begin{figure}[H]
    \centering
    \def\svgwidth{\columnwidth}
    \input{images/svg/navrh-softwarove-casti.pdf_tex}
    \caption{Návrh softwarové části systému.}
    \label{fig:navrh-softwarove-casti}
\end{figure}

\subsubsection{MQTT protokol}

MQTT (\textit{Message Queuing Telemetry Transport}) je jednoduchý a nenáročný M2M/„Internet Of Things“ komunikační protokol. Protokol je založen na principu předávání zpráv mezi klienty přes centrální server (broker). Centrální server přijímá zprávy od poskytovatele zprávy (tzv. publisher), které následně předává k přečtení čtenářům, kteří tuto zprávu odebírají (tzv. subscribers). Publisher obvykle představuje nějaký sensor či měřící jednotku, která vysílá naměřeného hodnoty na broker, zatímco subscriber obvykle tvoří nějaká řídící jednotka, která hodnoty odebírá (přijímá) a dále s nimi pracuje  nebo je zobrazuje.

Přenášené zprávy jsou tříděny do témat (topic). Každá zpráva patří právě do jednoho tématu, přičemž témata definuje přímo publisher. Subscriber pak musí předem znát jméno (označení) tématu, aby se mohlo přihlásit u~brokeru k jeho odběru. Subscriber nemusí znát umístění ani komunikační adresu publisheru. Musí jen znát komunikační adresu (umístění) brokeru. Témata jsou hierarchická a oddělená lomítky. Příklad struktury tématu: „dum/patro/loznice/sensor/teplota“, lze tak přehledně roztřídit jednotlivá umístění zařízení a případné rozšiřování systému je pak snadné. Příklad schématu komunikace a struktury topiců je zobrazena na obrázku \ref{fig:mqtt-protokol}.

\begin{figure}[H]
    \centering
    \def\svgwidth{\columnwidth}
    \input{images/svg/mqtt-protokol.pdf_tex}
    \caption{Základní funkční schéma MQTT komunikace. Příklad přenosu hodnot do koncových zařízení. Znak \# nahrazuje jednu či více úrovní, budou přijímány subscribers  všechny zprávy tykající se prvního patra domu.}
    \label{fig:mqtt-protokol}
\end{figure}

Obsahem zprávy není přesně definován. Nejčastěji se používá formát (způsob zápisu) dat JSON (\textit{JavaScript Object Notation}), BSON (\textit{Binary JSON}) nebo textové zprávy. Velikost zprávy je pak v aktuální verzi protokolu omezena na necelých 256 MB, ale vzhledem k využití „Internet of Things“ bývá většina zpráv mnohem menší.

Protokol MQTT popisuje jen samotný popis struktury přenášených zpráv, ale nedefinuje způsob přenosu. K tomu se využívá TCP/IP protokol. Protokol definuje tři úrovně potvrzování zpráv QoS (\textit{Quality of Service}). QoS 0 – Zpráva je odeslána bez potvrzení a není zaručeno její doručení. QoS 1 – Publisher zprávu odešle a přes broker je od odběratelů posláno potvrzení, broker může poslat potvrzení, aniž by měl potvrzení od všech odběratelů (závisí na implementaci). QoS 2 – Publisher zprávu odešle, broker pošle publisherovi potvrzení o přijetí na kterou publisher odpoví potvrzením, broker zprávu smaže a potvrdí zprávou, tím je komunikace mezi publisherem a brokerem uzavřena. Tato komunikace probíhá i mezi brokerem a odběrateli.


V přihlašovací sekvenci se využívá identifikace klienta pomocí ID a pak volitelně i pomocí uživatelské jména a hesla. MQTT díky podpoře SSL/TLS umožňuje přihlášení pomocí klientského SSL certifikátu.
\subsubsection{I$^2$C sběrnice}
Jedná se o sériovou, synchronní sběrnici. Komunikace probíhá na dvou vodičích, jeden tvoří hodinový vodič (SCL – \textit{Synchronous Clock}) a datový vodiče (SDA – \textit{Synchronous Data}). Vodiče jsou sdílené mezi připojenými zařízeními, proto je možné aby kdokoliv komunikoval s kýmkoliv (komunikace je v této konfiguraci náročnější na zpracování). Typické zapojení sběrnice je v konfiguraci jeden Master, který veškerou komunikaci řídí, a několik zařízení Slave, viz obrázek \ref{fig:i2c-sbernice}. Nicméně existuje varianta s více Mastery, existuje sada pravidel, jak se musí chovat, aby mohli na sběrnici pracovat společně a neovlivňovali se. Na vodičích SCL a SDA je připojen „pull-up“ rezistor (R), v neutrálním stavu je na vodičích log. 1. Připojená zařízení po sběrnici komunikují pomocí otevřeného kolektoru (mohou sběrnici stáhnout k zemi (log. 0), po odpojení je na sběrnici opět log. 1).

\begin{figure}[H]
    \centering
    \def\svgwidth{\columnwidth}
    \input{images/svg/i2c-sbernice.pdf_tex}
    \caption{Zapojení I$^2$C sběrnice. Jedno zařízení pracuje v režimu „master“, ostatní zařízení v režimu slave „slave“.}
    \label{fig:i2c-sbernice}
\end{figure}

Komunikace vždy začíná START sekvencí (na SDA se vygeneruje sestupná hrana, na SCL je držena log. 1) a končí STOP sekvencí (na SDA se vygeneruje vzestupná hrana, na SCL je držena log.). SDA nesmí nikdy měnit svojí hodnotu, když je SCL v log. 1.  Přenos jednoho bitu zprávy probíhá, takže SCL je v log. 0, změní vysílač hodnotu SDA na takovou, jak potřebuje. Poté nastaví SCL do log. 1. Se vzestupnou hranou pak přijímač čte hodnotu na SDA. Vysílač opět vrátí SCL do log. 0 a celý proces se opakuje s dalším bitem zprávy. Zpráva se skládá z 9 bitů. Prvních 8 bitů je datových a devátý bit je potvrzovací (log. 0 pro potvrzení nebo log. 1 a vysílač z toho vyrozumí, že zpráva není potvrzená). Nejednodušší tvar zprávy se skládá ze START sekvence, 8 bitů, potvrzovací devátý bit a STOP sekvence. Prvních 7 bitů po START sekvenci tvoří adresu zařízení (každý Slave má unikátní adresu, jinak dojde ke kolizi) a osmí bit rozhoduje o směru toku dat (zda se bude zapisovat log. 1 či číst log. 0), každý byte se potvrzuje devátým bitem, buď potvrzuje Slave, když Master posílá data nebo naopak Master potvrzuje, když posílá Slave. Tak to se potvrzuje až na poslední byte, tím se zařízení dozví,že komunikace končí a~má uvolnit SDA linku. Poté se odešle STOP sekvence. Zobrazení komunikace je na obrázku \ref{fig:i2c-sbernice-datova-komunikace-7bit-adresa}.

\begin{figure}[H]
    \centering
    \def\svgwidth{\columnwidth}
    \input{images/svg/i2c-sbernice-datova-komunikace-7bit-adresa.pdf_tex}
    \caption{Příklad I$^2$C datové komunikace se 7-bitovou adresací. Upraveno z~\cite{i2c-sbernice-datovy-paket-7bit-adresa}.}
    \label{fig:i2c-sbernice-datova-komunikace-7bit-adresa}
\end{figure}

Adresace je možná pomocí 7 bitů (128 unikátních adres, číslo je však poníženo ještě o speciální adresy, např. broadcast adresa apod.) nebo 10 bitů (1024 unikátních adres), zde se pak adresy přenáší ve dvou bytech (pro první byte se používá vyhrazená adres, kde jsou uloženy dva nejvyšší bity adresy, v~druhém bytu je dolních osm bitů adresy).

Podle verze sběrnice je frekvenci SCL 100 kHz, 400 kHz, 1 MHz nebo až 3,4 MHz. Rychlost je pak přizpůsobena nejpomalejšímu zařízení na sběrnici. Pull-up rezistory jsou v řádech jednotek kiloohmů, s rostoucí frekvencí nebo delší vzdálenosti sběrnice se jejich velikosti volí menší.




\subsubsection{1-Wire sběrnice}

\subsubsection{Inteligentní část systému}
Pro co největší využití centrálního řízení podlahového vytápění je vhodné využít různé metody pro její optimalizaci, což se následně promítne do nákladů energie, tak též i do teplotního konfortu uživatelů. Jednou z metod je využití předpovědi počasí, kdy dopředu víme teplotní předpověď, kterou můžeme začlenit do teplotních programů (časově definované úsek pro vytápění) definované uživatel a základě  předpovědi se rozhodnout, zda je nutné místnosti natápět dříve v případě snížení venkovní teploty nebo naopak s vytápěním počkat. Další možností 

\subsubsection{Řídicí systémy}